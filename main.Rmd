---
title: "Proyecto - Riesgos en Entidades Financieros"
author: 
  - Luis Fernando Amey Apuy 
  - Javier Hernández Navarro 
  - Anthony Mauricio Jiménez Navarro 
  - Gustavo Alberto Amador Fonseca 
  - Johan Castaño Bustamante 
date: "`r Sys.Date()`"
output:
  rmdformats::robobook:
    self_contained: true
    highlight: tango
---

# Importación y librerías
```{r}
pacman::p_load(
  readr,
  tidyverse, 
  ggplot2,
  dplyr,
  isotree,
  recipes,
  keras,
  tibble,
  tensorflow,
  torch,
  ComplexUpset
)
```

```{r, message=FALSE}
bank <- read_csv("data/bank_transactions_data_2.csv")
```

# AED
```{r}
bank %>%
  count(AccountID) %>%
  ggplot(aes(x = n)) +
  geom_histogram(binwidth = 1, boundary = 0.5, fill = "steelblue", color = "white") +
  scale_x_continuous(breaks = 1:12, limits = c(0.5, 12.5)) +
  labs(
    x = "Número de registros por cuenta (n)",
    y = "Frecuencia"
  ) +
  theme_minimal()
```

```{r}
ggplot(bank, aes(x = TransactionAmount)) +
  geom_histogram(
    bins = 30,               # cantidad de barras (puedes ajustar)
    fill = "steelblue",
    color = "white"
  ) +
  labs(
    x = "Monto de transacción",
    y = "Frecuencia"
  ) +
  theme_minimal()
```

```{r}
bank %>%
  group_by(AccountID) %>%
  summarise(mean_balance = mean(AccountBalance, na.rm = TRUE)) %>%
  ggplot(aes(x = mean_balance)) +
  geom_histogram(
    bins = 30,                # podés ajustar la cantidad de barras
    fill = "steelblue",
    color = "white"
  ) +
  labs(
    x = "Balance promedio por cuenta",
    y = "Número de cuentas"
  ) +
  theme_minimal()

```

# Z score
```{r}
mean_amount <- mean(bank$TransactionAmount)
std_amount <- sd(bank$TransactionAmount)
anomaly_threshold <- mean_amount + 2 * std_amount

# Flag anomalies
bank$Is_Anomaly <-  bank$TransactionAmount > anomaly_threshold
```

## Resultado
```{r, warning=FALSE, echo=FALSE, message=FALSE}
fig <- ggplot(bank, aes(x = TransactionAmount,
                 y = AccountBalance,
                 color = factor(Is_Anomaly))) +
  geom_point(alpha = 0.7) +
  labs(color = "Is Anomaly",
       x = "Transaction Amount",
       y = "Account Balance",
       title = "Transacciones vs Balance") +
  theme_minimal()
fig
ggsave("res/Zsc.pdf", fig, width = 8, height = 4)
```

# Isolation Forest
## Preparación
```{r}
features <- bank %>%
  select(TransactionAmount, AccountBalance,
         TransactionDuration, LoginAttempts, CustomerAge) 


rec <- recipe(~ ., data = features) %>%
  step_center(all_numeric()) %>%
  step_scale(all_numeric())

prep_rec <- prep(rec, training = features)
features_scaled <- bake(prep_rec, new_data = features)
```

## Modelo
```{r}
iso_model <- isolation.forest(
  as.matrix(features_scaled),
  ntrees = 100,
  sample_size = 256,
  nthreads = 2
)


iso_scores <- predict(iso_model, as.matrix(features_scaled), type = "score")
bank$iso_score <- iso_scores


threshold_iso <- quantile(iso_scores, 0.95)
# Reescribir en la base de datos
bank$iso_anomaly_flag <- iso_scores > threshold_iso
```

## Resultado
```{r, warning=FALSE, echo=FALSE, message=FALSE}
fig <- ggplot(bank, aes(x = TransactionAmount,
                 y = AccountBalance,
                 color = factor(iso_anomaly_flag))) +
  geom_point(alpha = 0.7) +
  labs(color = "Is Anomaly",
       x = "Transaction Amount",
       y = "Account Balance",
       title = "Transacciones vs Balance") +
  theme_minimal()
fig
ggsave("res/iso.pdf", fig, width = 8, height = 4)
```

# Autoencoder
## Preparación
```{r}
x <- torch_tensor(as.matrix(features_scaled), dtype = torch_float())

input_dim <- ncol(features_scaled)
encoder_dim <- round(input_dim / 2)


autoencoder <- nn_module(
  initialize = function() {
    self$encoder <- nn_linear(input_dim, encoder_dim)
    self$decoder <- nn_linear(encoder_dim, input_dim)
  },
  
  forward = function(x) {
    x %>%
      self$encoder() %>%
      nnf_relu() %>%
      self$decoder()
  }
)

model <- autoencoder()
optimizer <- optim_adam(model$parameters, lr = 0.001)
loss_fn <- nn_mse_loss()
```

## Entrenamiento
```{r}
epochs <- 50
batch_size <- 32
n <- x$size(1)

for (epoch in 1:epochs) {
  idx <- sample(1:n)
  x <- x[idx, ]
  
  for (i in seq(1, n, by = batch_size)) {
    batch <- x[i:min(i + batch_size - 1, n), ]
    
    optimizer$zero_grad()
    output <- model(batch)
    loss <- loss_fn(output, batch)
    loss$backward()
    optimizer$step()
  }
}
```

## Reconstrucción y MSE
```{r}
recon <- as.array(model(x)$to(device = "cpu"))
orig <- as.matrix(features_scaled)

mse <- rowMeans((orig - recon)^2)
bank$ae_mse <- mse

threshold_ae <- quantile(mse, 0.95)
bank$ae_anomaly_flag <- mse > threshold_ae
```

## Resultado
```{r, warning=FALSE, echo=FALSE, message=FALSE}
fig <- ggplot(bank, aes(x = TransactionAmount,
                 y = AccountBalance,
                 color = factor(ae_anomaly_flag))) +
  geom_point(alpha = 0.7) +
  labs(color = "Is Anomaly",
       x = "Transaction Amount",
       y = "Account Balance",
       title = "Transacciones vs Balance") +
  theme_minimal()
fig
ggsave("res/AE.pdf", fig, width = 8, height = 4)
```

# Interpretación de modelos
```{r, echo=FALSE}
comparison <- bank %>%
  mutate(
    z_score_flag = Is_Anomaly,
    iso_flag = iso_anomaly_flag,
    ae_flag = ae_anomaly_flag
  ) %>%
  select(z_score_flag, iso_flag, ae_flag,
         iso_score, ae_mse, TransactionAmount)


anomaly_rates <- data.frame(
  Modelo = c("Z-Score", "Isolation Forest", "Autoencoder"),
  Porcentaje = 100 * c(
    mean(comparison$z_score_flag),
    mean(comparison$iso_flag),
    mean(comparison$ae_flag)
  )
)


score_corr <- cor(
  comparison %>% select(iso_score, ae_mse),
  method = "spearman"
)[1,2]


agreement_matrix <- table(
  ISO = comparison$iso_flag,
  AE = comparison$ae_flag,
  Z = comparison$z_score_flag
)


comparison <- comparison %>%
  mutate(
    iso_rank = rank(-iso_score),
    ae_rank = rank(-ae_mse)
  )
```

## Porcentaje de anomalías detectadas
```{r, echo=FALSE}
print(anomaly_rates)
```

## Correlación entre AE y ISO
```{r, echo=FALSE}
print(score_corr)
```

## Coincidencia entre modelos (tabla cruzada)
```{r, echo=FALSE}
df_upset <- as.data.frame(
  lapply(
    bank[c("Is_Anomaly", "iso_anomaly_flag", "ae_anomaly_flag")],
    as.integer
  )
)
colnames(df_upset) <- c("Z", "ISO", "AE")
```

```{r, echo=FALSE, warning=FALSE}
fig <- upset(df_upset,
      intersect = c("Z", "ISO", "AE"),
      set_sizes = FALSE,
      base_annotations = list(
        'Intersection size' = intersection_size(
        fill = "steelblue"    
    )
  ))
fig 
ggsave("res/comp.pdf", fig, width = 8, height = 4)
```
